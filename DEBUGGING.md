# DEBUGGING & ERROR MESSAGE IMPROVEMENTS

This document lists discovered diagnostic shortcomings in the Vex compiler, the prioritized plan to improve error messages, and a running TODO list at the top.

---

## TODO

- [x] Add structured Diagnostic fields (primary/secondary span, code, suggestions).
- [x] Implement JSON diagnostic output for LSP/CLI.
- [x] Improve parser spans and error recovery.
- [x] Add parser recovery timeout guard to prevent infinite loops.
- [x] Add "did you mean" suggestions for unresolved names.
- [ ] Map macro expansions and backtrace to original source.
- [x] Add compile-fail/golden regression tests for diagnostic messages (basic JSON & LSP mapping tests).
- [ ] Add documentation for error codes and suggestions.
- [x] Audit parser for additional infinite-loop risks and add loop guards.

---

## Summary of discovered gaps

1. Spans & source map

   - AST nodes and token stream don't consistently carry precise spans and original file mappings.
   - Macro expansion mappings are missing.

2. Parser/Lexer

   - Incomplete span tracking in tokens.
   - Parser emits single error then stops, without good recovery or multiple related error reporting.
   - Error messages are basic and lack suggestions.

3. Diagnostic model

   - Diagnostics lack structured fields: primary/secondary spans, stable error codes, suggestion/fix-its, 'notes', and 'help' text.
   - No structured JSON output for editors or LSP.

4. Type-checker & HIR/MIR

   - Contextual type errors lack sources of truth (HIR/MIR spans) and narrative.

5. Name resolution & suggestions

   - "not found" errors do not provide 'did you mean' or auto-fix suggestions.

6. Macro expansion & includes

   - Errors in expanded macros point to generated code instead of original source.

7. Tooling

   - No consistent LSP integration or JSON diagnostic output.
   - CLI lacks colorized snippet and caret highlighting.

8. Testing
   - Diagnostic regression/golden tests are missing.

---

## Prioritized Plan

1. Spans & tokens (foundation)

   - Ensure `Span` is attached to tokens and AST nodes.
   - Track file + offset mapping for macro expansions.

2. Diagnostic model (foundation)

   - Extend `Diagnostic` in `vex-diagnostics` to have: error_code (string), primary_span (Span), secondary_spans (Vec<Span>), level, suggestions (Vec<String>), notes, category.
   - Add JSON serialization for Diagnostics.

3. Parser & Lexer improvements

   - Update parser to collect multiple errors with recovery.
   - Improve tokenization to create informative `UnexpectedToken` and `UnexpectedEOF` diagnostics.

4. Name resolution & suggestions

   - Add simple Levenshtein-based `did you mean` suggestions and import suggestions.

5. Type checker / HIR context

   - Improve diagnostic context by referencing HIR/MIR spans and related nodes.

6. Macro & include mapping

   - Create mapping from expanded source to original location and make diagnostics span back to original.

7. LSP & CLI UX

   - Add JSON output format for diagnostics and an LSP extension.
   - Add colorized CLI snippet display.

8. Testing & Docs
   - Add compile-fail / golden tests and diagnostic docs.

---

## Implementation Notes / Quick Wins

- Start by adding fields to `Diagnostic` and a JSON schema to support tooling.
- Add a simple diagnostic printer in `vex-formatter` and a JSON printer in `vex-cli`.
- Add unit tests for diagnostic serialization and improved message format.
- Use golden test files (expected diagnostics) to lock in regression cases.
- Add dynamic stdlib module detection for resolver (avoid stale constants in code).
- Add primary_label to commonly emitted diagnostics and DiagnosticEngine helpers.

---

## Completed changes

- Added `primary_label`, `related` spans, and suggestion serialization to `Diagnostic` and JSON output.
- Extended `Diagnostic` API with `with_primary_label` and `with_related` helper methods.
- Updated parser `ParseError` generation to include `primary_label` and help messages for some errors.
- Implemented parser recovery loop-iteration guard (`RECOVERY_MAX_STEPS = 10000`) to detect and prevent infinite loops.
- Added tests: serialization tests and a non-hanging parser recovery test.
- Added guards and `emit_timeout_and_advance` to protect many parser loops (async block, struct body, trait body, extern block, enums, policies, etc.).
- Added loop-guard helper `emit_timeout_and_advance` on `Parser` to centralize timeout handling.

---

## How to contribute / next steps

- See this document's TODO checklist. Update this file as steps are completed.
- Pair: prefer starting with `vex-diagnostics` changes then parser/lexer changes.

---

_Generated by Copilot - diagnostic improvement planning & todo_
