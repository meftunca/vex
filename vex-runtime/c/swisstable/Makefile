# SwissTable Makefile
# High-performance hash map implementation

CC := clang
CFLAGS := -std=c11 -O3 -march=native -Wall -Wextra
CFLAGS_DEBUG := -std=c11 -g -O0 -Wall -Wextra -fsanitize=address
INCLUDES := -I..

# Targets
.PHONY: all test bench clean help v1 v2 v3

all: libvex_swisstable.a vex_swisstable_test
	@echo "âœ… SwissTable build complete"

help:
	@echo "SwissTable Makefile"
	@echo ""
	@echo "Targets:"
	@echo "  all          - Build library and test"
	@echo "  test         - Build and run tests"
	@echo "  bench        - Run benchmarks"
	@echo "  v1           - Test V1 (stable)"
	@echo "  v2           - Test V2 (recommended)"
	@echo "  clean        - Clean build artifacts"

# Build V1 library
libvex_swisstable.a: vex_swisstable.c
	$(CC) $(CFLAGS) -c -o vex_swisstable.o vex_swisstable.c
	ar rcs libvex_swisstable.a vex_swisstable.o

# Build V2 library
libvex_swisstable_v2.a: vex_swisstable_v2.c vex_swisstable_optimized.h
	$(CC) $(CFLAGS) -c -o vex_swisstable_v2.o vex_swisstable_v2.c
	ar rcs libvex_swisstable_v2.a vex_swisstable_v2.o

# Test executables
vex_swisstable_test: vex_swisstable_test.c vex_swisstable.c ../vex.h
	$(CC) $(CFLAGS) $(INCLUDES) -o vex_swisstable_test vex_swisstable_test.c vex_swisstable.c

vex_swisstable_test_v2: vex_swisstable_test.c vex_swisstable_v2.c vex_swisstable_optimized.h ../vex.h
	$(CC) $(CFLAGS) $(INCLUDES) -DUSE_V2 -o vex_swisstable_test_v2 vex_swisstable_test.c vex_swisstable_v2.c

# Benchmark executables
bench_v1_vs_v2: bench_v1_vs_v2.c vex_swisstable.c vex_swisstable_v2.c ../vex.h
	$(CC) $(CFLAGS) $(INCLUDES) -o bench_v1_vs_v2 bench_v1_vs_v2.c vex_swisstable.c vex_swisstable_v2.c

bench_ultimate: bench_ultimate.c vex_swisstable.c vex_swisstable_v2.c vex_swisstable_v3.c ../vex.h
	$(CC) $(CFLAGS) $(INCLUDES) -o bench_ultimate bench_ultimate.c \
		vex_swisstable.c vex_swisstable_v2.c vex_swisstable_v3.c

bench_delete: vex_swisstable_bench_delete.c vex_swisstable_v2.c ../vex.h
	$(CC) $(CFLAGS) $(INCLUDES) -o bench_delete vex_swisstable_bench_delete.c vex_swisstable_v2.c

# Test targets
test: vex_swisstable_test
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  ðŸ§ª SwissTable Tests"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	./vex_swisstable_test
	@echo ""
	@echo "âœ… All tests passed!"

v1: vex_swisstable_test
	@echo "Testing SwissTable V1..."
	./vex_swisstable_test

v2: vex_swisstable_test_v2
	@echo "Testing SwissTable V2..."
	./vex_swisstable_test_v2

# Benchmark targets
bench: bench_ultimate
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  ðŸ† SwissTable Benchmarks"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	./bench_ultimate
	@echo ""

bench-compare: bench_v1_vs_v2
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  ðŸ“Š V1 vs V2 Comparison"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	./bench_v1_vs_v2
	@echo ""

bench-delete: bench_delete
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  ðŸ—‘ï¸  Delete Performance"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	./bench_delete
	@echo ""

# Clean
clean:
	rm -f *.o *.a
	rm -f vex_swisstable_test vex_swisstable_test_v2
	rm -f bench_v1_vs_v2 bench_ultimate bench_delete
	rm -f insert_analysis
	@echo "âœ… SwissTable clean complete"

# Info
info:
	@echo "SwissTable Information"
	@echo "====================="
	@echo ""
	@echo "Versions:"
	@echo "  V1 - Stable baseline"
	@echo "  V2 - Optimized (RECOMMENDED) â­"
	@echo "  V3 - Experimental (DO NOT USE)"
	@echo ""
	@echo "Performance (V2):"
	@echo "  Insert: 30.47M ops/s"
	@echo "  Lookup: 53.86M ops/s"
	@echo "  Delete: 18.20M ops/s"
	@echo ""
	@echo "vs Competitors:"
	@echo "  2.8x faster than Rust hashbrown (insert)"
	@echo "  3.4x faster than Rust hashbrown (lookup)"
	@echo ""
	@cat README.md 2>/dev/null | head -30 || echo "See README.md for details"

