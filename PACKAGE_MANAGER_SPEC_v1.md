# Vex Package Manager Specification (v1.0)

**Version:** 1.0  
**Last Updated:** November 7, 2025  
**Status:** ✅ Finalized

---

## Table of Contents

1. [Overview](#overview)
2. [Manifesto: vex.json](#manifesto-vexjson)
3. [Lock File: vex.lock](#lock-file-vexlock)
4. [CLI Commands](#cli-commands)
5. [Dependency Resolution](#dependency-resolution)
6. [Authentication](#authentication)
7. [Package Structure](#package-structure)
8. [Implementation Phases](#implementation-phases)

---

## Overview

### Philosophy

**"Cargo'nun gücü, Go Mod'un sadeliği"**

- ✅ **Decentralized**: Git-based, no central registry
- ✅ **Fast**: Parallel downloads, global cache
- ✅ **Secure**: Lock files, SHA-256 checksums
- ✅ **Simple**: Single `vex` command (compiler + package manager)

### Key Decisions

1. **Format**: JSON (not TOML)
2. **Lock File**: JSON (not custom)
3. **Authentication**: System git credentials
4. **Resolution**: Go-style flat dependency tree
5. **Entrypoint**: `src/lib.vx` (customizable via `main`)
6. **Nexus Mirror**: Phase 2+ (not initially supported)
7. **FFI Dependencies**: Phase 2+ (not initially supported)

---

## Manifesto: vex.json

### Basic Structure

```json
{
  "name": "my-package",
  "version": "0.1.0",
  "description": "High-performance Vex server",
  "authors": ["Your Name <email@example.com>"],
  "license": "MIT",

  "dependencies": {
    "github.com/vex-lang/json": "v1.2.0",
    "gitlab:company/internal-lib": "v1.5.0",
    "https://cdn.example.com/pkg.tar.gz": {
      "version": "v1.0.0",
      "headers": {
        "Authorization": "Bearer token123"
      }
    }
  },

  "vex": {
    "borrowChecker": "strict"
  },

  "profiles": {
    "development": {
      "optimizationLevel": 0,
      "debugSymbols": true
    },
    "testing": {
      "optimizationLevel": 1,
      "debugSymbols": true,
      "memProfiling": true,
      "cpuProfiling": true
    },
    "production": {
      "optimizationLevel": 3,
      "debugSymbols": false
    }
  }
}
```

### Dependency Protocols

#### 1. GitHub (Default)

```json
"github.com/user/repo": "v1.2.0"
```

- No prefix required
- Git clone: `https://github.com/user/repo.git`
- Tag: `v1.2.0`

#### 2. GitLab (Explicit)

```json
"gitlab:company/repo": "v1.5.0"
```

- Explicit `gitlab:` prefix
- Git clone: `https://gitlab.com/company/repo.git`
- Private repos use git credentials

#### 3. Other Git Services

```json
"bitbucket:team/project": "v2.0.0"
```

- Explicit prefix required
- Supported: `bitbucket:`, `gitea:`, etc.

#### 4. HTTP/HTTPS Direct Download

```json
"https://cdn.example.com/pkg-v1.0.0.tar.gz": {
    "version": "v1.0.0",
    "headers": {
        "Authorization": "Bearer secret_token",
        "X-Custom-Header": "value"
    }
}
```

- Full URL required
- `headers` field optional (for authentication)
- `version` field optional (usually in URL)

### Profiles

Default profiles if not specified:

```json
{
  "development": {
    "optimizationLevel": 0,
    "debugSymbols": true
  },
  "production": {
    "optimizationLevel": 3,
    "debugSymbols": false
  }
}
```

Profile selection:

- `vex build` → development profile
- `vex build --release` → production profile
- `vex build --profile=testing` → custom profile

### Optional Fields

#### Custom Entrypoint

```json
{
  "name": "my-package",
  "main": "src/custom_entry.vx"
}
```

Default: `src/lib.vx`

#### Binary Package

```json
{
  "name": "my-cli-tool",
  "main": "src/main.vx",
  "bin": {
    "my-tool": "src/main.vx"
  }
}
```

Creates executable: `vex-builds/my-tool`

---

## Lock File: vex.lock

### Format

```json
{
  "version": 1,
  "lockTime": "2025-11-07T15:30:00Z",
  "dependencies": {
    "github.com/vex-lang/json": {
      "version": "v1.2.0",
      "resolved": "https://github.com/vex-lang/json/archive/v1.2.0.tar.gz",
      "integrity": "sha256:a3f5b2c1d4e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x5y6z7",
      "dependencies": {
        "github.com/vex-lang/utf8": "v2.1.0"
      }
    },
    "github.com/vex-lang/utf8": {
      "version": "v2.1.0",
      "resolved": "https://github.com/vex-lang/utf8/archive/v2.1.0.tar.gz",
      "integrity": "sha256:b4g6c3d5e7f8g9h0i1j2k3l4m5n6o7p8q9r0s1t2u3v4w5x6y7z8"
    }
  }
}
```

### Properties

- **version**: Lock file format version (currently 1)
- **lockTime**: Timestamp of lock generation
- **integrity**: SHA-256 checksum for validation
- **resolved**: Full download URL (immutability)
- **dependencies**: Transitive dependencies (flat tree)

### Management

- ✅ Auto-generated by `vex add`, `vex update`
- ✅ Committed to Git
- ❌ Never manually edited

---

## CLI Commands

### Phase 1 Commands

```bash
# Project management
vex new <name>              # Create new project
vex init                    # Initialize vex.json in existing dir

# Dependency management
vex add <package>[@version] # Add dependency
vex remove <package>        # Remove dependency
vex update                  # Update all dependencies

# Build & run
vex build                   # Build (development profile)
vex build --release         # Build (production profile)
vex build --profile=testing # Build (custom profile)
vex run                     # Build and run
vex test                    # Run tests
vex clean                   # Clean build cache

# Information
vex list                    # List dependencies
vex tree                    # Show dependency tree
vex outdated                # Show outdated dependencies
```

### Examples

```bash
# GitHub package
vex add github.com/vex-lang/json@v1.2.0
vex add github.com/vex-lang/json  # Latest version

# GitLab package
vex add gitlab:company/internal-lib@v1.5.0

# HTTP direct
vex add https://cdn.example.com/pkg-v1.0.0.tar.gz

# Remove
vex remove json

# Update all
vex update
```

---

## Dependency Resolution

### Strategy: Go-style Flat Dependency Tree

#### Minimum Version Selection (MVS)

When multiple versions required, **highest version wins**:

```
Project dependencies:
  - github.com/vex-lang/json@v1.2.0
    └── github.com/vex-lang/utf8@v2.1.0

  - github.com/vex-lang/router@v3.0.0
    └── github.com/vex-lang/utf8@v2.0.0

Resolution:
  ✅ utf8@v2.1.0 (highest SemVer)
```

#### Conflict Resolution

SemVer incompatible versions cause **build error**:

```
Error: Version conflict for github.com/vex-lang/utf8
  - json@v1.2.0 requires utf8@v2.x
  - old-lib@v1.0.0 requires utf8@v1.x
  ❌ Cannot resolve (major version conflict)

Solution: Update old-lib or use different version
```

### Versioning Rules

- **Semantic Versioning (SemVer)**: `v1.2.3` (major.minor.patch)
- **v prefix required**: `v1.0.0` not `1.0.0` (Go convention)
- **Compatible**: `v1.2.x` compatible with `v1.3.x`
- **Incompatible**: `v1.x.x` incompatible with `v2.x.x`

---

## Authentication

### Strategy: System Git Credentials

`vex` uses existing git configuration and SSH keys.

#### GitHub Private Repos

```bash
# SSH key (recommended)
ssh-add ~/.ssh/id_rsa

# HTTPS token
git config --global credential.helper store
echo "https://username:token@github.com" >> ~/.git-credentials
```

`vex add github.com/company/private-repo@v1.0.0`:

1. Uses system git credentials
2. Prefers SSH if key available
3. Falls back to HTTPS + token
4. Errors if authentication fails

#### GitLab Private Repos

```bash
# SSH key
ssh-add ~/.ssh/id_gitlab

# Access token
export GITLAB_TOKEN=your_token  # Optional
```

`vex add gitlab:company/internal-lib@v1.0.0`:

- Uses GitLab SSH/HTTPS credentials
- Reads `GITLAB_TOKEN` if set

#### HTTP Headers (Private CDN)

```json
"https://private-cdn.com/pkg.tar.gz": {
    "headers": {
        "Authorization": "Bearer secret_token"
    }
}
```

### Advantages

- ✅ No Vex-specific configuration needed
- ✅ Works with existing git workflow
- ✅ SSH keys + credential helpers supported
- ✅ CI/CD compatible (system git config)

---

## Package Structure

### Standard Layout

```
my-package/
├── vex.json              # Package manifest
├── vex.lock              # Lock file (committed to git)
├── src/
│   ├── lib.vx            # Default entrypoint (public API)
│   ├── internal.vx       # Private module
│   └── utils.vx          # Internal utilities
├── tests/
│   ├── lib_test.vx       # Unit tests
│   └── integration_test.vx
└── examples/
    └── basic_usage.vx    # Usage examples
```

### Entrypoint Rules

**Default**: `src/lib.vx`

**Custom**: Specify in `vex.json`

```json
{
  "name": "my-package",
  "main": "src/custom_entry.vx"
}
```

### Export Rules

Public API defined in entrypoint:

```vex
// src/lib.vx
export fn parse(data: string): Result<Json, Error> {
    // Public function
}

fn internal_helper(): i32 {
    // Private function (no export)
}
```

Usage in other packages:

```vex
import { parse } from "github.com/vex-lang/json";

fn main(): i32 {
    let json = parse("{\"key\": \"value\"}");
    return 0;
}
```

### Binary vs Library

**Library Package** (default):

```json
{
  "name": "json-parser",
  "version": "1.0.0",
  "main": "src/lib.vx"
}
```

**Binary Package** (executable):

```json
{
  "name": "my-cli-tool",
  "version": "1.0.0",
  "bin": {
    "my-tool": "src/main.vx"
  }
}
```

`vex build` → creates `vex-builds/my-tool` binary

---

## Implementation Phases

### Phase 1: MVP (Minimum Viable Product)

**Timeline:** 2-3 weeks

**Features:**

- ✅ `vex.json` format (JSON)
- ✅ Git-based dependencies (GitHub, GitLab)
- ✅ Semantic versioning (`v1.2.3`)
- ✅ Global cache (`~/.vex/cache/`)
- ✅ Lock file (`vex.lock` with SHA-256)
- ✅ System git authentication
- ✅ Go-style dependency resolution (MVS)
- ✅ Basic CLI commands (new, add, remove, build, run)

**Commands:**

```bash
vex new my_project
vex add github.com/user/pkg@v1.0.0
vex build
vex run
```

**Not Included:**

- ❌ FFI dependencies
- ❌ HTTP direct download
- ❌ Nexus mirror
- ❌ Advanced commands (tree, outdated)

---

### Phase 2: HTTP & Advanced Features

**Timeline:** 1-2 weeks after Phase 1

**Features:**

- ✅ HTTP/HTTPS direct download
- ✅ Private URL headers
- ✅ Dependency tree visualization (`vex tree`)
- ✅ Outdated package detection (`vex outdated`)
- ✅ Lock file validation

**Commands:**

```bash
vex add https://cdn.com/pkg.tar.gz
vex tree
vex outdated
vex verify  # Verify lock file integrity
```

---

### Phase 3: FFI Dependencies

**Timeline:** 2-3 weeks (after language is stable)

**Features:**

- ✅ System-installed FFI libs (pkg-config)
- ✅ `ffiDependencies` in `vex.json`
- ✅ Pre-built binary downloads (Nexus)
- ✅ Source compilation fallback

**Example:**

```json
{
  "ffiDependencies": {
    "openssl": "system",
    "zlib": "3.0.0"
  }
}
```

---

### Phase 4: Nexus Mirror & Ecosystem

**Timeline:** 1-2 months (after v1.0)

**Features:**

- ✅ Nexus CDN mirror (`nexus.vex.dev`)
- ✅ Package publishing workflow
- ✅ Package search & discovery
- ✅ Documentation hosting
- ✅ CI/CD integration guides

**Environment:**

```bash
export VEX_PROXY=https://nexus.vex.dev
vex build  # Uses mirror
```

---

## Appendix: Standard Library

### `std` Module

- `std` is **built into the compiler** (not a dependency)
- `vex` version = `std` version (e.g., `vex v1.0.0` → `std v1.0.0`)
- No download required

**Usage:**

```vex
import { http } from "std";  // Always available

fn main(): i32 {
    let response = http.get("https://example.com");
    return 0;
}
```

**Advantages:**

- ✅ No dependency management needed
- ✅ Version consistency guaranteed
- ✅ Fast builds (pre-compiled std lib)

---

## Summary

| Feature              | Phase 1 (MVP) | Phase 2 | Phase 3 | Phase 4 |
| -------------------- | ------------- | ------- | ------- | ------- |
| **vex.json**         | ✅            | ✅      | ✅      | ✅      |
| **vex.lock**         | ✅            | ✅      | ✅      | ✅      |
| **Git dependencies** | ✅            | ✅      | ✅      | ✅      |
| **HTTP download**    | ❌            | ✅      | ✅      | ✅      |
| **FFI dependencies** | ❌            | ❌      | ✅      | ✅      |
| **Nexus mirror**     | ❌            | ❌      | ❌      | ✅      |
| **System auth**      | ✅            | ✅      | ✅      | ✅      |
| **MVS resolution**   | ✅            | ✅      | ✅      | ✅      |

---

**Status:** ✅ Specification complete, ready for implementation

**Next Steps:**

1. Implement Phase 1 (MVP) package manager
2. Test with real-world packages
3. Gather community feedback
4. Iterate and improve

---

**Maintained by:** Vex Language Team  
**Contact:** meftunca (GitHub)
