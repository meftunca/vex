// OpenSSL Crypto Test
// Test hashing, HMAC, encryption, and random number generation

import { ffi } from "std";

fn test_hashing() {
    println("=== Hashing Tests ===");
    
    let data = "Hello, Vex with OpenSSL!".as_bytes();
    
    // SHA256
    let sha256_hash = ffi.openssl.sha256(data);
    print("SHA256: ");
    for byte in sha256_hash {
        print(f"{byte:02x}");
    }
    println("");
    
    // SHA512
    let sha512_hash = ffi.openssl.sha512(data);
    print("SHA512: ");
    for i in 0..16 { // Print first 16 bytes
        print(f"{sha512_hash[i]:02x}");
    }
    println("...");
    
    // MD5 (legacy)
    let md5_hash = ffi.openssl.md5(data);
    print("MD5:    ");
    for byte in md5_hash {
        print(f"{byte:02x}");
    }
    println("\n");
}

fn test_hmac() {
    println("=== HMAC Test ===");
    
    let key = "secret_key".as_bytes();
    let data = "message_to_authenticate".as_bytes();
    
    let hmac = ffi.openssl.hmac_sha256(key, data);
    print("HMAC-SHA256: ");
    for byte in hmac {
        print(f"{byte:02x}");
    }
    println("\n");
}

fn test_random() {
    println("=== Random Number Generation ===");
    
    let random_bytes = ffi.openssl.random_bytes(16)?;
    print("Random bytes: ");
    for byte in random_bytes {
        print(f"{byte:02x} ");
    }
    println("\n");
}

fn test_base64() {
    println("=== Base64 Encoding ===");
    
    let data = "Hello, World!".as_bytes();
    let encoded = ffi.openssl.base64_encode(data);
    println(f"Original: Hello, World!");
    println(f"Encoded:  {encoded}");
    
    let decoded = ffi.openssl.base64_decode(encoded)?;
    let decoded_str = string.from_bytes(decoded);
    println(f"Decoded:  {decoded_str}\n");
}

fn test_password_hash() {
    println("=== Password Hashing (PBKDF2 simulation) ===");
    
    let password = "my_secure_password".as_bytes();
    let salt = ffi.openssl.random_bytes(16)?;
    
    // Simple iteration (real PBKDF2 would iterate thousands of times)
    let mut hash = password;
    for i in 0..100 {
        hash = ffi.openssl.sha256(hash);
    }
    
    print("Password hash: ");
    for i in 0..16 {
        print(f"{hash[i]:02x}");
    }
    println("...\n");
}

fn test_integrity_check() {
    println("=== Data Integrity Check ===");
    
    let data = "This is important data that must not be tampered with!";
    let original_hash = ffi.openssl.sha256(data.as_bytes());
    
    println(f"Original data: {data}");
    print("Original hash: ");
    for i in 0..8 {
        print(f"{original_hash[i]:02x}");
    }
    println("...");
    
    // Simulate data transmission
    let received_data = data; // In real scenario, this might be modified
    let received_hash = ffi.openssl.sha256(received_data.as_bytes());
    
    // Verify integrity
    let mut is_valid = true;
    for i in 0..original_hash.len() {
        if original_hash[i] != received_hash[i] {
            is_valid = false;
            break;
        }
    }
    
    if is_valid {
        println("✓ Data integrity verified!");
    } else {
        println("✗ Data has been tampered with!");
    }
    println("");
}

fn main() : i32 {
    println("=== OpenSSL Crypto Test Suite ===\n");
    
    test_hashing();
    test_hmac();
    test_random();
    test_base64();
    test_password_hash();
    test_integrity_check();
    
    println("=== All crypto tests completed! ===");
    
    return 0;
}
