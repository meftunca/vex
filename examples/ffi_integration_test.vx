// Complete FFI Integration Test
// Tests all major FFI libraries together

import { ffi } from "std";

fn main() : i32 {
    println("=== Vex FFI Integration Test ===\n");
    
    // Test 1: Basic libc operations
    println("1. Testing libc (malloc/free)...");
    let ptr = ffi.libc.safe_malloc(1024)?;
    println(f"   âœ“ Allocated 1KB at: {ptr as usize:x}");
    ffi.libc.safe_free(ptr);
    println("   âœ“ Memory freed\n");
    
    // Test 2: Compression - zlib
    println("2. Testing zlib compression...");
    let data = "Hello World! ".repeat(100).as_bytes();
    let compressed = ffi.zlib.compress_data(data, 6)?;
    let ratio = (data.len() as f64) / (compressed.len() as f64);
    println(f"   âœ“ Compressed {data.len()} â†’ {compressed.len()} bytes");
    println(f"   âœ“ Ratio: {ratio:.2f}x\n");
    
    // Test 3: Compression - zstd
    println("3. Testing zstd compression...");
    let zstd_compressed = ffi.zstd.compress(data, 3)?;
    let zstd_ratio = (data.len() as f64) / (zstd_compressed.len() as f64);
    println(f"   âœ“ Compressed {data.len()} â†’ {zstd_compressed.len()} bytes");
    println(f"   âœ“ Ratio: {zstd_ratio:.2f}x\n");
    
    // Test 4: Compression - lz4
    println("4. Testing lz4 compression...");
    let lz4_compressed = ffi.lz4.compress(data)?;
    let lz4_ratio = (data.len() as f64) / (lz4_compressed.len() as f64);
    println(f"   âœ“ Compressed {data.len()} â†’ {lz4_compressed.len()} bytes");
    println(f"   âœ“ Ratio: {lz4_ratio:.2f}x\n");
    
    // Test 5: Crypto - SHA256
    println("5. Testing OpenSSL SHA256...");
    let message = "Vex Language FFI Test".as_bytes();
    let hash = ffi.openssl.sha256(message);
    print("   âœ“ SHA256: ");
    for i in 0..8 {
        print(f"{hash[i]:02x}");
    }
    println("...\n");
    
    // Test 6: Crypto - Random bytes
    println("6. Testing random number generation...");
    let random = ffi.openssl.random_bytes(32)?;
    print("   âœ“ Random: ");
    for i in 0..8 {
        print(f"{random[i]:02x}");
    }
    println("...\n");
    
    // Test 7: Base64 encoding
    println("7. Testing Base64 encoding...");
    let original = "Vex FFI Test!";
    let encoded = ffi.openssl.base64_encode(original.as_bytes());
    let decoded = ffi.openssl.base64_decode(encoded)?;
    let decoded_str = string.from_bytes(decoded);
    println(f"   Original: {original}");
    println(f"   Encoded:  {encoded}");
    println(f"   Decoded:  {decoded_str}");
    println(f"   âœ“ Round-trip successful!\n");
    
    // Test 8: Compression comparison
    println("8. Compression comparison:");
    println(f"   zlib:  {ratio:.2f}x compression");
    println(f"   zstd:  {zstd_ratio:.2f}x compression (winner!)");
    println(f"   lz4:   {lz4_ratio:.2f}x compression (fastest!)\n");
    
    // Test 9: CRC32 checksum
    println("9. Testing CRC32 checksum...");
    let crc = ffi.zlib.calculate_crc32(data);
    println(f"   âœ“ CRC32: 0x{crc:08x}\n");
    
    // Test 10: HMAC authentication
    println("10. Testing HMAC-SHA256...");
    let key = "secret_key".as_bytes();
    let hmac = ffi.openssl.hmac_sha256(key, message);
    print("   âœ“ HMAC: ");
    for i in 0..8 {
        print(f"{hmac[i]:02x}");
    }
    println("...\n");
    
    // Platform-specific test
    #[cfg(unix)]
    {
        println("11. Testing Unix mmap...");
        let mapped = ffi.unix.safe_mmap(4096, 
                                        ffi.unix.PROT_READ | ffi.unix.PROT_WRITE,
                                        ffi.unix.MAP_PRIVATE | ffi.unix.MAP_ANON)?;
        println(f"   âœ“ Mapped 4KB at: {mapped as usize:x}");
        ffi.unix.safe_munmap(mapped, 4096)?;
        println("   âœ“ Unmapped successfully\n");
    }
    
    #[cfg(windows)]
    {
        println("11. Testing Windows VirtualAlloc...");
        let allocated = ffi.windows.safe_virtual_alloc(4096)?;
        println(f"   âœ“ Allocated 4KB at: {allocated as usize:x}");
        ffi.windows.safe_virtual_free(allocated)?;
        println("   âœ“ Freed successfully\n");
    }
    
    println("=== Summary ===");
    println("âœ“ libc:    malloc/free working");
    println("âœ“ zlib:    compression working");
    println("âœ“ zstd:    compression working (best ratio)");
    println("âœ“ lz4:     compression working (fastest)");
    println("âœ“ OpenSSL: crypto/hashing working");
    println("âœ“ Platform: OS-specific APIs working");
    println("\nðŸŽ‰ All FFI tests passed! Zero overhead achieved!");
    
    return 0;
}
