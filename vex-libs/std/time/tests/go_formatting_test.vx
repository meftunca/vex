// Time Module - Go-Style Formatting Test
// Tests Go-style time formatting and parsing

import { now, unix, format, parse, Time } from "time";

fn main(): i32 {
    println("=== Time Module: Go-Style Formatting Test ===");

    // Test 1: Format with common layouts
    println("Test 1: Format with Common Layouts");
    let t = unix(1609459200, 123456789); // 2021-01-01 00:00:00.123456789 UTC

    let layouts = [
        ("2006-01-02", "2021-01-01"),
        ("15:04:05", "00:00:00"),
        ("2006-01-02 15:04:05", "2021-01-01 00:00:00"),
        ("Mon Jan 2 15:04:05 MST 2006", "Fri Jan 1 00:00:00 UTC 2021"),
        ("2006-01-02T15:04:05.000000000Z", "2021-01-01T00:00:00.123456789Z"),
        ("02 Jan 06 15:04 MST", "01 Jan 21 00:00 UTC"),
    ];

    for i in 0..layouts.len() {
        let layout = layouts[i].0;
        let expected = layouts[i].1;
        let formatted = format(t, layout);
        println("✓ Layout '" + layout + "' -> '" + formatted + "'");
    }

    // Test 2: Parse with layouts
    println("Test 2: Parse with Layouts");
    let parse_test_cases = [
        ("2006-01-02", "2021-01-01", 1609459200),  // 2021-01-01 00:00:00 UTC
        ("15:04:05", "14:30:45", 1609501845),     // Same date, different time
        ("2006-01-02 15:04:05", "2021-06-15 09:15:30", 1623746130),
    ];

    let! parse_success = 0;
    for i in 0..parse_test_cases.len() {
        let layout = parse_test_cases[i].0;
        let value = parse_test_cases[i].1;
        let expected_unix = parse_test_cases[i].2;

        match parse(layout, value) {
            Ok(parsed_time) => {
                let actual_unix = unix(parsed_time);
                if actual_unix == expected_unix {
                    println("✓ Parsed '" + value + "' with layout '" + layout + "'");
                    parse_success = parse_success + 1;
                } else {
                    println("⚠ Parsed '" + value + "' -> expected Unix " + expected_unix.to_string() + ", got " + actual_unix.to_string());
                }
            }
            Err(e) => {
                println("✗ Failed to parse '" + value + "' with layout '" + layout + "': " + e);
            }
        }
    }

    // Test 3: Round-trip format/parse
    println("Test 3: Round-trip Format/Parse");
    let original = now();
    let layout = "2006-01-02 15:04:05.000000000";
    let formatted = format(original, layout);

    match parse(layout, formatted) {
        Ok(parsed_back) => {
            let orig_unix = unix(original);
            let parsed_unix = unix(parsed_back);
            let diff = (orig_unix - parsed_unix).abs();
            if diff <= 1 { // Allow 1 second difference due to rounding
                println("✓ Round-trip successful");
                println("  Original Unix: " + orig_unix.to_string());
                println("  Formatted: " + formatted);
                println("  Parsed Unix: " + parsed_unix.to_string());
            } else {
                println("⚠ Round-trip failed with diff: " + diff.to_string() + " seconds");
            }
        }
        Err(e) => {
            println("✗ Round-trip parse failed: " + e);
        }
    }

    // Test 4: Invalid formats
    println("Test 4: Invalid Formats");
    let invalid_cases = [
        ("2006-01-02", "not-a-date"),
        ("15:04:05", "25:00:00"),  // Invalid hour
        ("2006-01-02", "2021-13-01"),  // Invalid month
    ];

    for i in 0..invalid_cases.len() {
        let layout = invalid_cases[i].0;
        let value = invalid_cases[i].1;

        match parse(layout, value) {
            Ok(t) => {
                println("⚠ '" + value + "' with layout '" + layout + "' should have failed");
            }
            Err(e) => {
                println("✓ '" + value + "' with layout '" + layout + "' correctly rejected: " + e);
            }
        }
    }

    // Test 5: Complex layouts
    println("Test 5: Complex Layouts");
    let complex_time = unix(1640995200, 500000000); // 2022-01-01 00:00:00.5 UTC
    let complex_layouts = [
        "Monday, January 2, 2006 at 3:04:05 PM",
        "2006-01-02T15:04:05.999999999Z07:00",
        "Jan _2 15:04:05.000",
    ];

    for i in 0..complex_layouts.len() {
        let layout = complex_layouts[i];
        let formatted = format(complex_time, layout);
        println("✓ Complex layout '" + layout + "' -> '" + formatted + "'");
    }

    println("=== Go-Style Formatting Test Complete ===");
    println("Successfully parsed " + parse_success.to_string() + "/" + parse_test_cases.len().to_string() + " test cases");
    return 0;
}