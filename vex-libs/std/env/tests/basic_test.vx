// Environment Module Tests
// Tests for environment variable operations

import { get, set, unset, has, get_or } from "env";
import { assert, assert_eq, log } from "testing";

fn test_basic_env_operations(): i32 {
    // Test set and get
    let test_key: String = "VEX_TEST_VAR";
    let test_value: String = "test_value_123";
    
    // Set environment variable
    let set_ok: bool = set(test_key, test_value);
    if !set_ok {
        return 1; // Set failed
    }
    
    // Check exists
    if !has(test_key) {
        return 2; // Variable should exist
    }
    
    // Get value
    let retrieved: String = get(test_key);
    if retrieved != test_value {
        return 3; // Value mismatch
    }
    
    // Unset
    let unset_ok: bool = unset(test_key);
    if !unset_ok {
        return 4; // Unset failed
    }
    
    // Verify removed
    if has(test_key) {
        return 5; // Variable should not exist
    }
    
    return 0; // Success
}

fn test_get_or_default(): i32 {
    let fake_key: String = "VEX_NONEXISTENT_VAR_XYZ";
    let default_val: String = "default_value";
    
    // Should return default for nonexistent variable
    let result: String = get_or(fake_key, default_val);
    if result != default_val {
        return 1; // Should return default
    }
    
    // Set the variable
    set(fake_key, "actual_value");
    
    // Should return actual value now
    let result2: String = get_or(fake_key, default_val);
    if result2 != "actual_value" {
        return 2; // Should return actual value
    }
    
    // Cleanup
    unset(fake_key);
    
    return 0;
}

fn test_system_env_vars(): i32 {
    // Common environment variables that should exist
    // (These exist on Unix systems)
    
    // PATH should exist
    if !has("PATH") {
        return 1; // PATH should exist
    }
    
    let path_val: String = get("PATH");
    if path_val == "" {
        return 2; // PATH should not be empty
    }
    
    // HOME should exist (on Unix)
    if !has("HOME") {
        // This is OK on some systems, not a failure
    }
    
    return 0;
}

fn main(): i32 {
    println("Running env module tests...");
    
    // Test 1: Basic operations
    let result1: i32 = test_basic_env_operations();
    if result1 != 0 {
        println("FAIL: test_basic_env_operations");
        return result1;
    }
    println("PASS: test_basic_env_operations");
    
    // Test 2: get_or default
    let result2: i32 = test_get_or_default();
    if result2 != 0 {
        println("FAIL: test_get_or_default");
        return result2;
    }
    println("PASS: test_get_or_default");
    
    // Test 3: System environment variables
    let result3: i32 = test_system_env_vars();
    if result3 != 0 {
        println("FAIL: test_system_env_vars");
        return result3;
    }
    println("PASS: test_system_env_vars");
    
    println("All env tests passed!");
    return 0;
}
